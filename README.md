# Smart4Health MyScience App

## Acknowledgements

<img src="./img/eu.jpg" align="left" alt="European Flag" width="60">

This project has received funding from the European Unionâ€™s Horizon 2020 research and innovation programme under grant agreement No 826117.

## About this app

<img src="app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png"/>

With the MyScience App you have the possibility of providing your health data for research and scientific purposes after
you complete a separate consent. Therein, you can select the purpose for your data provision, decide if you want to
provide your full data or just selected parts, and if you want to be re-contacted for research results on a general
level. Consenting to data provision also includes the option of revoking consent.

See the following resources:

- Android Play Store Download: https://play.google.com/store/apps/details?id=com.healthmetrix.s4h.myscience
- Official information:
    - https://smart4health.eu/myscience/
    - https://smart4health.eu/myscienceinfo/
- MyScience App Site: https://github.com/smart4health/my-science-app-site
    - Privacy Policy: https://myscience-app.smart4health.eu/privacy-statement-en.html
    - Terms of Use: https://myscience-app.smart4health.eu/terms-of-use-en.html

## Building

### Secrets

See [.drone.yml](.drone.yml) for secret locations

- The Firebase account's `google-services.json` in [app/](app/)
- a `secrets.properties` in the repo root with the following keys:
    - `gpr.user`: with a value of `hmx-robot` (not really a secret), used to pull D4L libraries
    - `gpr.token`: A token generated by `hmx-robot` to pull things from the *G*ithub *P*ackage *R*egistry

- Debug and release secrets in `debug.secrets.properties` and `release.secrets.properties` respectively
    - CHDP secrets. These are stripped of their `chdp.` prefix and applied directly as manifest placeholders
        - `chdp.clientId`: CHDP client ID
        - `chdp.clientSecret`: CHDP client secret, formerly `d4l.secret`
        - `chdp.environment`: `prod` in `release.secrets.properties`, `staging` otherwise
        - `chdp.redirectScheme`: Constant, `eu.smart4health.c0ec5256-78b9-4820-ade3-e0b0d6b7300b`
        - `chdp.debug`: Constant, `false`
        - `chdp.platform`: Constant, `s4h`
    - Data provisioning secrets. These are stripped of their `data-prov.` prefix, then all `.` become
      `_` and remaining letters are uppercased, before being injected to the app as `BuildConfig` fields
        - `data-prov.recontact.baseUrl`: API endpoint for recontact (ends in `/v1/`)
        - `data-prov.recontact.user`: Basic auth user for recontact
        - `data-prov.recontact.pass`: Basic auth password for recontact
        - `data-prov.qomop.baseUrl`: see recontact
        - `data-prov.qomop.user`: see recontact
        - `data-prov.qomop.pass`: see recontact
        - `data-prov.deident.baseUrl`: see recontact
        - `data-prov.deident.user`: see recontact
        - `data-prov.deident.pass`: see recontact
        - `data-prov.consent.host`: protocol + domain for consent, used for user facing pages instead of API operations
        - `data-prov.consent.baseUrl`: API endpoint for consent (ends in `/api/v1/`)

Here's a full template:

```properties
chdp.clientId=
chdp.clientSecret=
chdp.environment=
chdp.redirectScheme=
chdp.debug=
chdp.platform=
data-prov.recontact.baseUrl=
data-prov.recontact.user=
data-prov.recontact.pass=
data-prov.qomop.baseUrl=
data-prov.qomop.user=
data-prov.qomop.pass=
data-prov.deident.baseUrl=
data-prov.deident.user=
data-prov.deident.pass=
data-prov.consent.host=
data-prov.consent.baseUrl=
```

> Note: due to Android build type configuration not being lazy, you will need files for both
> debug and release, however, it works fine if release is empty as in the template

> Note: the passwords for prod are all the same, as they are behind one shared proxy

- keystore.jks,
- keystore.properties
    ```properties
    keystore=
    keystore_password=
    key_alias=
    key_password=
    ```
- upload-keystore.jks
- upload-keystore.properties
    ```properties
    keystore=
    keystore_password=
    key_alias=
    key_password=
    ```

### Configurations

#### Debug

Build apk and run tests:

```shell
./gradlew assembleDebug testDebug
```

#### Release

Run tests:

```shell
SIGNING_CONFIG=release ./gradlew testRelease
```

Build apk:

```shell
SIGNING_CONFIG=release ./gradlew assembleRelease copyReleaseApk
```

Output in `app/build/outputs/apk/release/com.healthmetrix.s4h.myscience-*.apk`

Build bundle:

```shell
SIGNING_CONFIG=upload ./gradlew bundleRelease copyReleaseBundle
```

Output in `app/build/outputs/bundle/release/com.healthmetrix.s4h.myscience-*.aab`


## Code Stats
Generated with [tokei](https://github.com/XAMPPRocky/tokei)

```
===============================================================================
 Language            Files        Lines         Code     Comments       Blanks
===============================================================================
 Batch                   1           89           68            0           21
 JSON                    2          133          133            0            0
 Kotlin                132         8992         7506          296         1190
 Prolog                  1           21           18            0            3
 Protocol Buffers        5          107           77            0           30
 Shell                   1          234          100          109           25
 TOML                    1          120           89            3           28
 XML                    98         7702         7370           25          307
-------------------------------------------------------------------------------
 Markdown                1          139            0          105           34
 |- Shell                1            4            4            0            0
 (Total)                            143            4          105           34
===============================================================================
 Total                 242        17537        15361          538         1638
===============================================================================
```